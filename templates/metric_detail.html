{% extends "base.html" %}

{% block title %}{{ metric_title }} - Last Resort Hotels{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('summary') }}">Summary</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ metric_title }}</li>
            </ol>
        </nav>
        <h2><i class="{{ metric_icon }}"></i> {{ metric_title }}</h2>
        <p class="text-muted">{{ metric_description }}</p>
    </div>
</div>

<!-- Summary Card -->
{% if summary_card %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white {{ summary_card.color }}">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="{{ summary_card.icon }}"></i> {{ summary_card.title }}
                </h5>
                <h2 class="card-text">{{ summary_card.value }}</h2>
                <small>{{ summary_card.subtitle }}</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart Section -->
{% if chart_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5><i class="{{ chart_icon }}"></i> {{ chart_title }}</h5>
            </div>
            <div class="card-body">
                <canvas id="metricChart" style="max-height: 400px;"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Table -->
{% if table_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-table"></i> {{ table_title }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                {% for header in table_headers %}
                                <th>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                            <tr>
                                {% if metric_title == 'Monthly Revenue Trend' %}
                                    <td><strong>{{ row.month }}</strong></td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue) }}</td>
                                    <td>{{ row.unique_customers }}</td>
                                    <td>{{ row.total_charges }}</td>
                                {% elif metric_title == 'Revenue by Service Type' %}
                                    <td><strong>{{ row.service_name }}</strong></td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue) }}</td>
                                    <td>{{ row.number_of_charges }}</td>
                                {% elif metric_title == 'Quarterly Revenue Analysis' or metric_title == 'Quarterly Revenue Trend' %}
                                    <td><strong>{{ row.revenue_year }}</strong></td>
                                    <td><strong>Q{{ row.revenue_quarter }}</strong></td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue) }}</td>
                                {% elif metric_title == 'Seasonal Revenue Analysis' %}
                                    <td><strong>{{ row.season }}</strong></td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue) }}</td>
                                    <td>{{ row.number_of_reservations }}</td>
                                {% elif metric_title == 'Occupancy Rate Trend' %}
                                    <td><strong>{{ row.month }}</strong></td>
                                    <td>{{ "{:.1f}".format(row.occupancy_rate) }}%</td>
                                    <td>{{ row.total_stays }}</td>
                                    <td>{{ row.unique_rooms_occupied }}</td>
                                {% elif metric_title == 'Top Revenue-Generating Customers' %}
                                    <td><strong>{{ row.customer_name }}</strong></td>
                                    <td><span class="badge bg-secondary">{{ row.party_type }}</span></td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue) }}</td>
                                    <td>{{ row.total_reservations }}</td>
                                    <td>{{ row.last_visit_date or 'N/A' }}</td>
                                {% elif metric_title == 'Customer Retention' %}
                                    <td><strong>{{ row.guest_name }}</strong></td>
                                    <td>{{ row.total_visits }}</td>
                                    <td>{{ row.total_nights }}</td>
                                    <td>{{ "{:.1f}".format(row.avg_nights_per_visit) }} nights</td>
                                {% elif metric_title == 'Most Booked Rooms' %}
                                    <td><strong>{{ row.room_number }}</strong></td>
                                    <td>{{ row.building_name }}</td>
                                    <td>{{ row.total_bookings }}</td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_revenue_generated) }}</td>
                                {% elif metric_title == 'Event Performance' %}
                                    <td><strong>{{ row.event_name }}</strong></td>
                                    <td>{{ row.host_organization }}</td>
                                    <td>{{ row.rooms_used }}</td>
                                    <td>{{ row.time_slots_used }}</td>
                                    <td class="text-success">${{ "{:,.2f}".format(row.total_event_revenue) }}</td>
                                    <td>{{ row.estimated_attendance }}</td>
                                {% elif metric_title == 'High-Risk Customer List' %}
                                    <td><strong>{{ row.customer_name }}</strong></td>
                                    <td>{{ row.party_type }}</td>
                                    <td><span class="badge bg-danger">{{ "{:.1f}".format(row.risk_score) }}</span></td>
                                    <td><span class="badge bg-warning">{{ row.payment_promptness_score }}</span></td>
                                    <td><span class="badge bg-info">{{ row.past_history_score }}</span></td>
                                    <td><span class="badge bg-secondary">{{ row.cooperativeness_score }}</span></td>
                                    <td><span class="badge bg-secondary">{{ row.flexibility_score }}</span></td>
                                    <td><span class="badge bg-primary">{{ "{:.1f}".format(row.overall_qualification_score) }}</span></td>
                                    <td class="text-danger">${{ "{:,.2f}".format(row.overdue_amount) }}</td>
                                    <td>{{ row.total_reservations }}</td>
                                {% else %}
                                    {% for value in row.values() %}
                                    <td>{{ value }}</td>
                                    {% endfor %}
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Back to Summary -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('summary') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Summary
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            <i class="fas fa-chart-bar"></i> View Full Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if chart_data %}
<script>
const ctx = document.getElementById('metricChart').getContext('2d');
const metricChart = new Chart(ctx, {
    type: '{{ chart_type }}',
    data: {
        labels: {{ chart_labels|tojson }},
        datasets: [{
            label: '{{ chart_dataset_label }}',
            data: {{ chart_data|tojson }},
            {% if chart_type == 'line' %}
            borderColor: '{{ chart_border_color }}',
            backgroundColor: '{{ chart_bg_color }}',
            tension: 0.4,
            fill: true
            {% elif chart_type == 'pie' %}
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(199, 199, 199, 1)'
            ],
            borderWidth: 2
            {% else %}
            backgroundColor: '{{ chart_bg_color }}',
            borderColor: '{{ chart_border_color }}',
            borderWidth: 2
            {% endif %}
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: true,
                position: '{{ chart_legend_position }}'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        {% if chart_type == 'pie' %}
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                        {% else %}
                        return '{{ chart_dataset_label }}: $' + context.parsed.y.toLocaleString();
                        {% endif %}
                    }
                }
            }
        },
        scales: {% if chart_type != 'pie' %}{
            y: {
                beginAtZero: true,
                {% if chart_max %}
                max: {{ chart_max }},
                {% endif %}
                ticks: {
                    callback: function(value) {
                        {% if chart_y_format == 'currency' %}
                        return '$' + value.toLocaleString();
                        {% elif chart_y_format == 'percentage' %}
                        return value + '%';
                        {% else %}
                        return value.toLocaleString();
                        {% endif %}
                    }
                }
            }
        }{% else %}undefined{% endif %}
    }
});
</script>
{% endif %}
{% endblock %}

